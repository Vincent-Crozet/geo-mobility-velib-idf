#!/bin/bash
set -e

echo "==============================="
echo " Airflow Entrypoint"
echo "==============================="

# ---------------------------
# Attente que PostgreSQL soit prÃªt
# ---------------------------
echo "â³ Waiting for PostgreSQL..."
until pg_isready -h "${POSTGRES_HOST:-postgres-airflow}" -p "${POSTGRES_PORT:-5432}" -U "${POSTGRES_USER:-airflow}"; do
    echo "PostgreSQL is unavailable - sleeping"
    sleep 2
done

# ---------------------------
# Generating user from env vars
# ---------------------------
# Create users.yaml from env vars
# cat > /opt/airflow/users.yaml <<EOF
# users:
#   - username: ${AIRFLOW_ADMIN_USERNAME}
#     password: ${AIRFLOW_ADMIN_PASSWORD}
#     first_name: ${AIRFLOW_ADMIN_FIRSTNAME}
#     last_name: ${AIRFLOW_ADMIN_LASTNAME}
#     email: ${AIRFLOW_ADMIN_EMAIL}
#     role: Admin
# EOF

# ---------------------------
# Generating secrets for manual configuration (instead of "airflow standalone")
# ---------------------------
# SECRETS_DIR="/opt/airflow/secrets"
# FERNET_FILE="$SECRETS_DIR/fernet.key"
# JWT_FILE="$SECRETS_DIR/jwt.key"

# mkdir -p "$SECRETS_DIR"

# if [ ! -f "$FERNET_FILE" ]; then
#   echo "ğŸ” Generating FERNET_KEY..."
#   python - <<EOF > "$FERNET_FILE"
# from cryptography.fernet import Fernet
# print(Fernet.generate_key().decode())
# EOF
# fi

# if [ ! -f "$JWT_FILE" ]; then
#   echo "ğŸ” Generating JWT_SECRET..."
#   openssl rand -hex 32 > "$JWT_FILE"
# fi

# export AIRFLOW__CORE__FERNET_KEY=$(cat "$FERNET_FILE")
# export AIRFLOW__API__JWT_SECRET=$(cat "$JWT_FILE")

# echo "âœ… Secrets loaded"
# echo $AIRFLOW__CORE__FERNET_KEY
# ---------------------------
# Initialisation DB et DAGs
# ---------------------------
echo "ğŸ—„ï¸ Migrating Airflow DB..."
# airflow db migrate

# echo "ğŸš€ Starting scheduler..."
# airflow scheduler &

# echo "ğŸŒ Starting API server..."
# exec airflow api-server 
# airflow standalone