services:
  redis:
    image: redis:7.2-alpine
    container_name: superset-redis
    restart: unless-stopped
    volumes:
      - redis-data:/data

  postgres:
    image: postgres:15
    container_name: superset-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: superset
      POSTGRES_USER: superset
      POSTGRES_PASSWORD: superset
    volumes:
      - postgres-data:/var/lib/postgresql/data

  superset:
    build:
      context: ./superset
      dockerfile: Dockerfile
    container_name: superset
    restart: unless-stopped
    environment:
      - DATABASE_DIALECT=postgresql
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_DB=superset
      - DATABASE_USER=superset
      - DATABASE_PASSWORD=superset
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - SUPERSET_SECRET_KEY=${SUPERSET_SECRET_KEY}
    ports:
      - "8088:8088"
    depends_on:
      - postgres
      - redis
    volumes:
      - superset-home:/app/superset_home
      # Optionnel : monter votre config personnalisée
      - ./superset/superset_config.py:/app/pythonpath/superset_config.py
    command:
      - /bin/sh
      - -c
      - |
        superset db upgrade
        superset fab create-admin --username ${SUPERSET_ADMIN_USERNAME} --firstname ${SUPERSET_ADMIN_FIRSTNAME} --lastname ${SUPERSET_ADMIN_LASTNAME} --email ${SUPERSET_ADMIN_EMAIL} --password ${SUPERSET_ADMIN_PASSWORD} || true
        superset init
        gunicorn --bind 0.0.0.0:8088 --workers 4 --timeout 120 --limit-request-line 0 --limit-request-field_size 0 "superset.app:create_app()"

volumes:
  redis-data:
  postgres-data:
  superset-home:

# Réseau par défaut - décommentez pour connecter à d'autres stacks
# networks:
#   default:
#     name: idfm_network
#     external: false

        # superset run -h 0.0.0.0 -p 8088 --with-threads --reload